<app-base-modal
  [isOpen]="isOpen"
  [config]="modalConfig"
  (close)="onClose()">
  
  <div class="special-charge-modal-content">
    <!-- Header -->
    <div class="modal-header">
      <button type="button" class="back-btn" (click)="onClose()">
        <img src="/icons/arrow-left.svg" alt="Back" />
      </button>
      <h2 class="modal-title">{{ 'Special Charge' | translate }}</h2>
      <div class="spacer"></div>
    </div>

    <!-- Modal Body -->
    <div class="modal-body">
      <!-- Table Info -->
      <div class="table-info">
        <img src="/icons/table.svg" alt="Table" class="table-icon" />
        <div class="table-details">
          <span class="table-number">{{ 'Table' | translate }} {{ specialChargeData?.tableNumber }}</span>
          <span class="client-count">• {{ specialChargeData?.clients?.length }} {{ 'clients' | translate }}</span>
        </div>
      </div>

      <!-- Client Filter -->
      <div class="client-filter">
        <button
          type="button"
          class="client-filter-btn"
          [class.active]="selectedClientFilter === 'all'"
          (click)="onClientFilterClick('all')">
          {{ 'All' | translate }}
        </button>
        <button
          *ngFor="let client of specialChargeData?.clients"
          type="button"
          class="client-filter-btn"
          [class.active]="selectedClientFilter === client.id"
          (click)="onClientFilterClick(client.id)">
          <img *ngIf="client.avatar" [src]="client.avatar" [alt]="client.name" class="client-avatar" />
          {{ client.name }}
        </button>
      </div>

      <!-- Summary -->
      <div class="summary-section">
        <h3 class="section-title">{{ 'Summary' | translate }}</h3>
        <div class="summary-items">
          <div class="summary-item" *ngFor="let item of specialChargeData?.orderItems">
            <span class="item-name">{{ item.name }} ×{{ item.quantity }}</span>
            <span class="item-price">${{ (item.price * item.quantity).toFixed(2) }}</span>
          </div>
        </div>

        <div class="summary-totals">
          <div class="summary-row">
            <span class="summary-label">{{ 'Sub Total' | translate }}</span>
            <span class="summary-value">${{ specialChargeData?.subTotal?.toFixed(2) }}</span>
          </div>
          <div class="summary-row">
            <span class="summary-label">{{ 'Discount' | translate }}</span>
            <span class="summary-value discount">-${{ specialChargeData?.discount?.toFixed(2) }}</span>
          </div>
          <div class="summary-row">
            <span class="summary-label">{{ 'Tax' | translate }} (10%)</span>
            <span class="summary-value">${{ specialChargeData?.tax?.toFixed(2) }}</span>
          </div>
          <div class="discount-applied-row" *ngIf="(specialChargeData?.discount || 0) > 0">
            <span class="discount-label">{{ 'Discount Applied' | translate }}</span>
            <img src="/icons/arrow-right.svg" alt=">" class="chevron-icon" />
          </div>
        </div>
      </div>

      <!-- Mode Toggle -->
      <div class="mode-section">
        <h3 class="section-title">{{ 'Mode' | translate }}</h3>
        <div class="mode-toggle">
          <button
            type="button"
            class="mode-btn"
            [class.active]="mode === 'individual'"
            (click)="onModeToggle('individual')">
            {{ 'Individual' | translate }}
          </button>
          <button
            type="button"
            class="mode-btn"
            [class.active]="mode === 'company'"
            (click)="onModeToggle('company')">
            {{ 'Company' | translate }}
          </button>
        </div>
      </div>

      <!-- Individual Mode -->
      <div class="individual-mode" *ngIf="mode === 'individual'">
        <!-- Payers Selection -->
        <div class="payers-section">
          <h3 class="section-title">{{ 'Payers (subset)' | translate }}</h3>
          <div class="payers-list">
            <button
              *ngFor="let client of specialChargeData?.clients"
              type="button"
              class="payer-btn"
              [class.selected]="isPayerSelected(client.id)"
              (click)="onPayerToggle(client.id)">
              <img *ngIf="client.avatar" [src]="client.avatar" [alt]="client.name" class="client-avatar" />
              {{ client.name }}
            </button>
          </div>
          <p class="split-error" *ngIf="splitError">{{ splitError }}</p>
        </div>

        <!-- Split -->
        <div class="split-section">
          <h3 class="section-title">{{ 'Split' | translate }}</h3>
          <div class="split-toggle">
            <button
              type="button"
              class="split-btn"
              [class.active]="splitType === '50-50'"
              (click)="onSplitTypeChange('50-50')">
              {{ '50/50' | translate }}
            </button>
            <button
              type="button"
              class="split-btn"
              [class.active]="splitType === 'divide-between'"
              (click)="onSplitTypeChange('divide-between')">
              {{ 'Divide between' | translate }}
            </button>
          </div>
        </div>

        <!-- Coupons -->
        <div class="coupons-section">
          <h3 class="section-title">{{ 'Coupons' | translate }}</h3>
          
          <!-- Global Coupons -->
          <div class="coupon-group">
            <label class="coupon-label">{{ 'Global' | translate }}</label>
            <div class="coupon-input-wrapper">
              <img src="/icons/ticket.svg" alt="Coupon" class="coupon-icon" />
              <input
                type="number"
                class="coupon-input"
                [(ngModel)]="globalCoupons"
                min="0"
                step="1" />
            </div>
            <p class="coupon-note">(prorated across selection)</p>
          </div>

          <!-- Per Person Coupons -->
          <div class="per-person-coupons">
            <div class="coupon-row" *ngFor="let client of specialChargeData?.clients">
              <label class="coupon-label">{{ client.name }}</label>
              <input
                type="number"
                class="coupon-input-small"
                [(ngModel)]="perPersonCoupons[client.id]"
                min="0"
                step="1" />
            </div>
          </div>

          <!-- Per Line Coupons -->
          <div class="per-line-coupons">
            <label class="coupon-label">{{ 'Per line' | translate }}</label>
            <div class="coupon-row" *ngFor="let item of specialChargeData?.orderItems">
              <span class="item-name">{{ item.name }}</span>
              <input
                type="number"
                class="coupon-input-small"
                [(ngModel)]="perLineCoupons[item.name]"
                min="0"
                step="1" />
            </div>
          </div>
        </div>
      </div>

      <!-- Company Mode -->
      <div class="company-mode" *ngIf="mode === 'company'">
        <!-- Payers (same as individual) -->
        <div class="payers-section">
          <h3 class="section-title">{{ 'Payers (subset)' | translate }}</h3>
          <div class="payers-list">
            <button
              *ngFor="let client of specialChargeData?.clients"
              type="button"
              class="payer-btn"
              [class.selected]="isPayerSelected(client.id)"
              (click)="onPayerToggle(client.id)">
              <img *ngIf="client.avatar" [src]="client.avatar" [alt]="client.name" class="client-avatar" />
              {{ client.name }}
            </button>
          </div>
        </div>

        <!-- Company Form -->
        <div class="company-form">
          <div class="form-group">
            <label class="form-label">{{ 'Legal name' | translate }}</label>
            <div class="input-wrapper">
              <img src="/icons/building.svg" alt="Building" class="input-icon" />
              <input
                type="text"
                class="form-input"
                [(ngModel)]="legalName"
                placeholder="Input legal name" />
            </div>
          </div>

          <div class="form-group">
            <label class="form-label">{{ 'VAT/TIN' | translate }}</label>
            <div class="input-wrapper">
              <img src="/icons/document.svg" alt="Document" class="input-icon" />
              <input
                type="text"
                class="form-input"
                [(ngModel)]="vatTin"
                placeholder="Input VAT/TIN" />
            </div>
          </div>

          <div class="form-group">
            <label class="form-label">{{ 'Invoice email' | translate }}</label>
            <div class="input-wrapper">
              <img src="/icons/mail.svg" alt="Mail" class="input-icon" />
              <input
                type="email"
                class="form-input"
                [(ngModel)]="invoiceEmail"
                placeholder="Input invoice email" />
            </div>
          </div>
        </div>

        <!-- Coupons (same as individual) -->
        <div class="coupons-section">
          <h3 class="section-title">{{ 'Coupons' | translate }}</h3>
          
          <div class="coupon-group">
            <label class="coupon-label">{{ 'Global' | translate }}</label>
            <div class="coupon-input-wrapper">
              <img src="/icons/ticket.svg" alt="Coupon" class="coupon-icon" />
              <input
                type="number"
                class="coupon-input"
                [(ngModel)]="globalCoupons"
                min="0"
                step="1" />
            </div>
            <p class="coupon-note">(prorated across selection)</p>
          </div>

          <div class="per-person-coupons">
            <div class="coupon-row" *ngFor="let client of specialChargeData?.clients">
              <label class="coupon-label">{{ client.name }}</label>
              <input
                type="number"
                class="coupon-input-small"
                [(ngModel)]="perPersonCoupons[client.id]"
                min="0"
                step="1" />
            </div>
          </div>

          <div class="per-line-coupons">
            <label class="coupon-label">{{ 'Per line' | translate }}</label>
            <div class="coupon-row" *ngFor="let item of specialChargeData?.orderItems">
              <span class="item-name">{{ item.name }}</span>
              <input
                type="number"
                class="coupon-input-small"
                [(ngModel)]="perLineCoupons[item.name]"
                min="0"
                step="1" />
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Modal Footer -->
    <div class="modal-footer">
      <div class="total-section">
        <span class="total-label">{{ 'TOTAL' | translate }}</span>
        <span class="total-value">${{ specialChargeData?.total?.toFixed(2) }}</span>
      </div>

      <div class="footer-actions">
        <button type="button" class="btn btn-secondary" (click)="onClose()">
          {{ 'Back' | translate }}
        </button>
        <button
          type="button"
          class="btn btn-primary"
          (click)="onConfirm()"
          [disabled]="splitError || (mode === 'company' && (!legalName || !vatTin || !invoiceEmail))">
          {{ getButtonText() | translate }}
        </button>
      </div>
    </div>
  </div>
</app-base-modal>

